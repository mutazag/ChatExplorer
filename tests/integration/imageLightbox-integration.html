<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>imageLightbox Integration</title>
    <link rel="stylesheet" href="../../src/ui/imageLightbox.css" />
    <style>
      body { font-family: system-ui, sans-serif; margin: 1rem; }
      .pass { color: #0a0; }
      .fail { color: #a00; }
      #fixture { margin-top: 1rem; }
      #fixture img { max-width: 200px; cursor: zoom-in; }
    </style>
  </head>
  <body>
    <h1>imageLightbox Integration</h1>
    <div id="results"></div>

    <div id="fixture">
      <button id="before">Before</button>
      <img id="thumb" data-lightbox="true" alt="Sample" src="../../assets/logo.svg" />
      <button id="after">After</button>
    </div>

    <script type="module" src="../lib/harness.js"></script>
    <script>
      // Load utilities and lightbox script (IIFE globals)
      const scripts = [
        '../../src/utils/a11y.js',
        '../../src/utils/mediaResolver.js',
        '../../src/ui/imageLightbox.js'
      ];
      scripts.forEach(src => {
        const s = document.createElement('script');
        s.src = src; s.defer = false; document.head.appendChild(s);
      });
    </script>

    <script type="module">
      import { test, assert } from '../lib/harness.js';

      function waitNextFrame() {
        return new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      }

      await test('opens overlay on image click', async () => {
        const img = document.getElementById('thumb');
        img.focus();
        img.click();
        await waitNextFrame();
        const overlay = document.querySelector('.image-lightbox');
        assert(!!overlay, 'overlay should exist after click');
        const dlg = overlay.getAttribute('role');
        assert(dlg === 'dialog', 'overlay should have role="dialog"');
      });

      await test('ESC closes and restores focus', async () => {
        const before = document.getElementById('before');
        const img = document.getElementById('thumb');
        // Open
        img.focus();
        img.click();
        await waitNextFrame();
        const overlay = document.querySelector('.image-lightbox');
        assert(!!overlay, 'overlay should exist before closing');
        // Send ESC
        const evt = new KeyboardEvent('keydown', { key: 'Escape', bubbles: true });
        document.dispatchEvent(evt);
        await waitNextFrame();
        const overlayGone = !document.querySelector('.image-lightbox');
        assert(overlayGone, 'overlay should be removed after ESC');
        // Focus should be restored to the origin (the image)
        assert(document.activeElement === img, 'focus should return to the image');
      });
    </script>
  </body>
</html>
